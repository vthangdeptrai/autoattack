local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Workspace = game:GetService("Workspace")

local player = Players.LocalPlayer

-- Đợi player load xong
repeat wait() until player and player.Character and player.Character:FindFirstChild("HumanoidRootPart")

-- Lấy Net
local net = ReplicatedStorage:WaitForChild("Modules"):WaitForChild("Net")
local registerAttack = net:FindFirstChild("RE/RegisterAttack")
local registerHit = net:FindFirstChild("RE/RegisterHit")

if not registerAttack or not registerHit then return end

local attackPerSecond = 40
local attackDelay = 1 / attackPerSecond
local attackRange = 100

-- Lấy NPC gần player nhất còn sống
local function GetClosestEnemy(maxDistance)
    local enemiesFolder = Workspace:FindFirstChild("Enemies") -- sửa tên folder nếu game khác
    if not enemiesFolder then return nil end
    local root = player.Character.HumanoidRootPart
    local closest = nil
    local minDist = maxDistance
    for _, npc in pairs(enemiesFolder:GetChildren()) do
        if npc and npc.Parent then
            local humanoid = npc:FindFirstChildOfClass("Humanoid")
            local head = npc:FindFirstChild("Head")
            if humanoid and humanoid.Health > 0 and head then
                local d = (head.Position - root.Position).Magnitude
                if d <= minDist then
                    closest = npc
                    minDist = d
                end
            end
        end
    end
    return closest
end

-- Auto Attack liên tục
task.spawn(function()
    while task.wait(attackDelay) do
        local targetNPC = GetClosestEnemy(attackRange)
        if targetNPC and targetNPC:FindFirstChild("Head") then
            pcall(function()
                registerAttack:FireServer(1)
                registerHit:FireServer(targetNPC.Head, {}, "default_code", 0.5)
            end)
        end
    end
end)
